# Cascade 刪除測試結果

## 測試資訊
- **測試任務**: 任務 4.2: Cascade 刪除測試
- **測試日期**: 2025/1/24
- **測試目的**: 驗證 User 模型的 `@Relationship(deleteRule: .cascade)` 設定正確運作

---

## 測試說明

### Cascade 刪除原理

在 User 模型中，我們定義了與 AnswerRecord 的關聯關係：

```swift
@Relationship(deleteRule: .cascade, inverse: \AnswerRecord.user)
var records: [AnswerRecord] = []
```

**cascade 刪除規則**：
- 當用戶被刪除時
- 所有關聯的 AnswerRecord 應該自動被刪除
- 這是透過 SwiftData 的 `deleteRule: .cascade` 實現

### 測試代碼位置

**檔案**: `ContentView.swift`

**測試按鈕**（僅在 DEBUG 模式顯示）：
```swift
#if DEBUG
Button(action: testDeleteUser) {
    HStack {
        Image(systemName: "trash")
        Text("🧪 測試刪除用戶")
    }
    .font(.caption)
    .foregroundColor(.white)
    .padding(.horizontal, 15)
    .padding(.vertical, 8)
    .background(Color.red)
    .cornerRadius(15)
}
.padding(.top, 20)
#endif
```

**測試函數**：
```swift
private func testDeleteUser() {
    print("🧪 開始測試 Cascade 刪除...")
    print("📊 刪除前狀態:")
    print("   - 用戶數量: \(users.count)")
    print("   - 記錄數量: \(records.count)")
    
    if let user = users.first {
        print("🗑️ 準備刪除用戶: \(user.name)")
        print("   - 用戶擁有的記錄數量: \(user.records.count)")
        
        // 刪除用戶（應該會 cascade 刪除所有關聯的記錄）
        modelContext.delete(user)
        
        do {
            try modelContext.save()
            print("✅ 用戶刪除成功")
            
            // 檢查刪除後的狀態
            print("📊 刪除後狀態:")
            print("   - 用戶數量: \(users.count)")
            print("   - 記錄數量: \(records.count)")
            
            if records.isEmpty {
                print("✅ Cascade 刪除測試通過！所有記錄已一併刪除")
            } else {
                print("⚠️ Cascade 刪除測試失敗！仍有 \(records.count) 筆記錄存在")
            }
        } catch {
            print("❌ 刪除失敗: \(error.localizedDescription)")
        }
    } else {
        print("⚠️ 沒有用戶可供刪除")
    }
    print("========================")
}
```

---

## 測試步驟

### 步驟 1: 準備測試資料
- [ ] 啟動 App
- [ ] 建立 3-5 筆問答記錄
- [ ] 驗證記錄已成功儲存（查看 Console 日誌）

**預期結果**:
- 用戶數量: 1
- 記錄數量: 3-5

**實際結果**:
- [ ] ✅ 通過
- [ ] ❌ 失敗 - 原因: _______________

---

### 步驟 2: 執行 Cascade 刪除測試
- [ ] 滾動到畫面底部
- [ ] 點擊「🧪 測試刪除用戶」按鈕（紅色按鈕）
- [ ] 觀察 Console 輸出

**預期 Console 輸出**:
```
🧪 開始測試 Cascade 刪除...
📊 刪除前狀態:
   - 用戶數量: 1
   - 記錄數量: 3
🗑️ 準備刪除用戶: 我的占卜
   - 用戶擁有的記錄數量: 3
✅ 用戶刪除成功
📊 刪除後狀態:
   - 用戶數量: 0
   - 記錄數量: 0
✅ Cascade 刪除測試通過！所有記錄已一併刪除
========================
```

**實際 Console 輸出**:
```
（貼上實際輸出）
```

**實際結果**:
- [ ] ✅ 通過 - 用戶和記錄都被刪除
- [ ] ⚠️ 部分通過 - 用戶刪除但記錄仍存在
- [ ] ❌ 失敗 - 刪除操作失敗

---

### 步驟 3: 驗證刪除結果
- [ ] 重新啟動 App
- [ ] 檢查 Console 的 SwiftData 狀態檢查輸出
- [ ] 驗證用戶和記錄都已清空

**預期結果**:
```
=== SwiftData 狀態檢查 ===
📊 用戶數量: 0
📊 記錄數量: 0
⚠️ 沒有找到用戶
📝 最近的記錄:
   ⚠️ 沒有任何記錄
========================
```

**實際結果**:
- [ ] ✅ 通過 - 用戶和記錄都已清空
- [ ] ❌ 失敗 - 仍有殘留資料

---

### 步驟 4: 驗證自動重建功能
- [ ] 輸入新問題並獲得答案
- [ ] 驗證新用戶自動建立
- [ ] 驗證記錄正常儲存

**預期結果**:
- 自動建立新的「我的占卜」用戶
- 記錄正常儲存並關聯到新用戶

**實際結果**:
- [ ] ✅ 通過
- [ ] ❌ 失敗 - 原因: _______________

---

## 測試結果總結

### 通過標準
- [ ] Cascade 刪除功能正常（刪除用戶時記錄一併刪除）
- [ ] 刪除操作成功執行（無錯誤）
- [ ] 刪除後資料庫狀態正確（用戶和記錄都清空）
- [ ] 刪除後可正常重建用戶和記錄

### 整體評估
- [ ] ✅ **測試通過** - Cascade 刪除功能完全正常
- [ ] ⚠️ **部分通過** - 有小問題但不影響核心功能
- [ ] ❌ **測試失敗** - Cascade 刪除功能異常

### 發現的問題

**問題 1**: _______________
- **嚴重程度**: [ ] 高 [ ] 中 [ ] 低
- **解決方案**: _______________
- **狀態**: [ ] 已解決 [ ] 待處理

**問題 2**: _______________
- **嚴重程度**: [ ] 高 [ ] 中 [ ] 低
- **解決方案**: _______________
- **狀態**: [ ] 已解決 [ ] 待處理

---

## 測試代碼管理

### 測試完成後的清理工作

**重要**: 測試完成後需要移除測試代碼，因為：
1. 測試按鈕不應該出現在正式版本
2. 用戶不應該有刪除所有資料的權限
3. 保持代碼整潔

**需要移除的代碼**:
1. `#if DEBUG` 區塊中的測試按鈕
2. `testDeleteUser()` 函數

**移除時機**:
- ✅ 測試通過並記錄結果後
- ✅ 確認 Cascade 刪除功能正常
- ✅ 更新 SwiftData_Todo.md 標記任務完成

**如何移除**:
```swift
// 移除這個區塊
#if DEBUG
Button(action: testDeleteUser) {
    // ...
}
#endif

// 移除這個函數
private func testDeleteUser() {
    // ...
}
```

---

## 技術細節

### Relationship deleteRule 選項

SwiftData 提供多種刪除規則：

1. **`.cascade`** (我們使用的)
   - 刪除父實體時，自動刪除所有子實體
   - 適用於強依賴關係（子實體離開父實體沒有意義）

2. **`.nullify`**
   - 刪除父實體時，子實體的外鍵設為 nil
   - 適用於弱依賴關係

3. **`.deny`**
   - 如果有子實體存在，禁止刪除父實體
   - 適用於需要保護資料的情況

4. **`.noAction`**
   - 不做任何處理，需要手動管理
   - 適用於複雜的刪除邏輯

### 為什麼選擇 .cascade

在我們的 App 中：
- AnswerRecord（問答記錄）完全依賴於 User（用戶）
- 沒有用戶的問答記錄沒有意義
- 刪除用戶時應該清理所有相關記錄
- 因此 `.cascade` 是最合適的選擇

---

## 預期的正常 Console 輸出

### 測試開始（有資料）
```
🧪 開始測試 Cascade 刪除...
📊 刪除前狀態:
   - 用戶數量: 1
   - 記錄數量: 5
🗑️ 準備刪除用戶: 我的占卜
   - 用戶擁有的記錄數量: 5
✅ 用戶刪除成功
📊 刪除後狀態:
   - 用戶數量: 0
   - 記錄數量: 0
✅ Cascade 刪除測試通過！所有記錄已一併刪除
========================
```

### 測試開始（無資料）
```
🧪 開始測試 Cascade 刪除...
📊 刪除前狀態:
   - 用戶數量: 0
   - 記錄數量: 0
⚠️ 沒有用戶可供刪除
========================
```

---

## 測試執行資訊

**測試執行人**: _______________  
**測試日期**: 2025/1/24  
**測試環境**:
- Xcode 版本: _______________
- iOS 版本: _______________
- 模擬器/實機: _______________
- 裝置型號: _______________

**測試耗時**: _____ 分鐘

---

## 備註

### 測試注意事項

1. **測試按鈕只在 DEBUG 模式顯示**
   - Release 版本不會包含測試按鈕
   - 確保正式發布時不會誤刪資料

2. **測試是破壞性的**
   - 刪除操作不可逆
   - 測試前確保不介意刪除測試資料

3. **測試完成後移除代碼**
   - 避免代碼庫中殘留測試代碼
   - 保持代碼整潔和專業

### 常見問題

**問題 1: 測試按鈕沒有顯示**
- **原因**: 可能在 Release 模式運行
- **解決**: 確認在 DEBUG 模式運行

**問題 2: 記錄沒有被刪除**
- **原因**: Relationship 設定可能錯誤
- **解決**: 檢查 User.swift 中的 `deleteRule: .cascade`

**問題 3: 刪除後資料仍然存在**
- **原因**: @Query 可能沒有更新
- **解決**: 重啟 App 確認資料真的被刪除

---

**文件結束**
